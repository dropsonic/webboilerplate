const { series, parallel, src, dest, task, watch } = require('gulp');
const ts = require('gulp-typescript');
const sass = require('gulp-sass');
const browserSync = require('browser-sync');
const del = require('del');

const tsProject = ts.createProject('tsconfig.json');
const browser = browserSync.create();

task('sass', function() {
	// prettier-ignore
	return src('src/**/*.scss')
		.pipe(sass())
		.pipe(dest('dist'))
		.pipe(browser.stream({ match: '**/*.css' }));
});

task('ts', function() {
	// prettier-ignore
	return tsProject.src()
		.pipe(tsProject())
		.js.pipe(dest('dist'))
		.pipe(browser.stream({ match: '**/*.js' }));
});

task('browserSync', () => {
	browserSync.init({
		server: {
			baseDir: 'dist'
		}
		// files: [ 'dist/*.html', 'dist/**/*.css', 'dist/**/*.js' ]
	});
});

task('clean', function(done) {
	del.sync('dist');
	done();
});

task('html', function() {
	// prettier-ignore
	return src('src/*.html')
		.pipe(dest('dist'));
});

task('build', parallel(task('clean'), task('ts'), task('sass'), task('html')));

task(
	'watch',
	series(
		task('build'),
		(done) => {
			watch('src/**/*.ts', task('ts'));
			watch('src/**/*.scss', task('sass'));
			watch('src/*.html', task('html'));
			watch('dist/*.html', browserSync.reload);
			done();
		},
		task('browserSync')
	)
);
